<% layout("/layouts/boilerplate") %>

<div class="container-fluid px-4 py-5">
  <div class="row">
    <!-- Header Section -->
    <div class="col-12 mb-4">
      <h2 class="display-5 fw-bold mb-2"><%= listing.title %></h2>
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted">
          <i class="fas fa-map-marker-alt"></i> <%= listing.location %>, <%=
          listing.country %>
        </span>
        <span class="text-muted">
          <i class="fas fa-user"></i> Hosted by @<%= listing.owner.username %>
        </span>
      </div>
    </div>

    <!-- Image Gallery Section -->
    <div class="col-12 mb-5">
      <div class="image-gallery rounded-4 overflow-hidden">
        <div class="row g-2">
          <div class="col-12 col-md-6">
            <img
              src="<%= listing.image.url %>"
              class="w-100 h-100 object-fit-cover main-gallery-img"
              style="max-height: 500px"
              alt="Main listing image"
            />
          </div>
          <div class="col-12 col-md-6">
            <div class="row g-2">
              <% for(let i = 1; i <= 4; i++) { %>
              <div class="col-6">
                <img
                  src="<%= listing.image.url %>"
                  class="w-100 h-100 object-fit-cover gallery-img"
                  style="height: 245px"
                  alt="Side image <%= i %>"
                />
              </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Section -->
    <div class="row">
      <!-- Left Column - Details -->
      <div class="col-12 col-lg-7 mb-4">
        <div class="mb-4">
          <h3 class="fs-4 mb-4">About this place</h3>
          <p class="text-muted"><%= listing.description %></p>
        </div>

        <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
        <div class="d-flex gap-2 mb-4">
          <a
            href="/listings/<%= listing._id %>/edit"
            class="btn btn-outline-dark"
          >
            <i class="fas fa-edit"></i> Edit
          </a>
          <form
            method="POST"
            action="/listings/<%=listing._id%>?_method=DELETE"
          >
            <button class="btn btn-danger">
              <i class="fas fa-trash"></i> Delete
            </button>
          </form>
        </div>
        <% } %>

        <!-- Reviews Section -->
        <div class="reviews-section">
          <h3 class="fs-4 mb-4">Reviews</h3>

          <% if(currUser) { %>
          <div class="add-review-card bg-light p-4 rounded-3 mb-4">
            <h5 class="mb-3">Leave a Review</h5>
            <form
              action="/listings/reviews/<%=listing._id%>"
              method="POST"
              novalidate
              class="needs-validation"
            >
              <div class="mb-3">
                <label class="form-label">Rating</label>
                <fieldset class="starability-slot">
                  <input
                    type="radio"
                    id="no-rate"
                    class="input-no-rate"
                    name="review[rating]"
                    value="1"
                    checked
                    aria-label="No rating."
                  />
                  <% for(let i = 1; i <= 5; i++) { %>
                  <input
                    type="radio"
                    id="first-rate<%= i %>"
                    name="review[rating]"
                    value="<%= i %>"
                  />
                  <label
                    for="first-rate<%= i %>"
                    title="<%= ['Terrible', 'Not good', 'Average', 'Very good', 'Amazing'][i-1] %>"
                    ><%= i %> star<%= i !== 1 ? 's' : '' %></label
                  >
                  <% } %>
                </fieldset>
              </div>

              <div class="mb-3">
                <label for="comment" class="form-label">Your experience</label>
                <textarea
                  name="review[comment]"
                  id="comment"
                  class="form-control"
                  rows="4"
                  required
                  placeholder="Share details of your stay to help other travelers"
                ></textarea>
                <div class="invalid-feedback">Please share your experience</div>
              </div>
              <button class="btn btn-dark">Submit Review</button>
            </form>
          </div>
          <% } %> <% if(listing.reviews.length > 0) { %>
          <div class="reviews-list">
            <% for(review of listing.reviews) { %>
            <div class="review-card bg-light p-4 rounded-3 mb-3">
              <div
                class="d-flex justify-content-between align-items-start mb-2"
              >
                <div>
                  <h6 class="mb-1">@<%= review.author.username %></h6>
                  <p
                    class="starability-result"
                    data-rating="<%= review.rating %>"
                  ></p>
                </div>
                <% if(currUser) { %>
                <form
                  method="POST"
                  action="/listings/reviews/<%= listing._id %>/<%= review._id %>?_method=DELETE"
                  class="d-inline"
                >
                  <button class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
                <% } %>
              </div>
              <p class="mb-0"><%= review.comment %></p>
            </div>
            <% } %>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Right Column - Booking Card -->
      <div class="col-12 col-lg-5">
        <div class="booking-card position-sticky" style="top: 2rem">
          <div class="card shadow-sm">
            <div class="card-body p-4">
              <h4 class="card-title mb-4">
                <span class="fs-2 fw-bold"
                  >â‚¹<%= listing.price.toLocaleString("en-IN") %></span
                >
                <span class="text-muted fs-5">/ night</span>
              </h4>

              <div class="date-picker row g-2 mb-4">
                <div class="col-6">
                  <div class="p-3 border rounded-3">
                    <small class="text-muted d-block">CHECK-IN</small>
                    <strong><%= checkin %></strong>
                  </div>
                </div>
                <div class="col-6">
                  <div class="p-3 border rounded-3">
                    <small class="text-muted d-block">CHECK-OUT</small>
                    <strong><%= checkout %></strong>
                  </div>
                </div>
              </div>

              <a href="/listings/<%= listing._id %>" class="d-grid">
                <button class="btn btn-dark btn-lg">Reserve</button>
              </a>
              <p class="text-center text-muted small mt-3 mb-0">
                You won't be charged yet
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .image-gallery img {
    transition: opacity 0.3s;
  }

  .image-gallery img:hover {
    opacity: 0.9;
  }

  .gallery-img {
    cursor: pointer;
  }

  .booking-card {
    transition: transform 0.3s;
  }

  @media (max-width: 768px) {
    .main-gallery-img {
      max-height: 300px !important;
    }

    .gallery-img {
      height: 150px !important;
    }

    .booking-card {
      position: static !important;
    }
  }

  .review-card {
    transition: transform 0.2s;
  }

  .review-card:hover {
    transform: translateY(-2px);
  }

  .btn {
    transition: all 0.3s;
  }
</style>
